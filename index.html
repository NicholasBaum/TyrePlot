<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tyre Plots Imola</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-2.24.2.min.js" charset="utf-8"></script>
</head>
<!-- https://nicholasbaum.github.io/TyrePlot/ -->

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>

    <div class="container">
        <div class="mb-3">
            <input class="form-control" type="file" id="fileInput">
            <select class="form-select" id="channelComboBox"></select>
        </div>
        <div id="plotElement"></div>
    </div>

    <script>

        let channels;
        let baseUrl;
        const repositoryOwner = 'NicholasBaum';
        const repositoryName = 'TyrePlot';
        let branchName = 'gh-pages';
        const subfolderPath = 'data';

        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            baseUrl = './';
            branchName = '';
        } else {
            baseUrl = `https://api.github.com/repos/${repositoryOwner}/${repositoryName}/contents/`;
        }

        const input = document.getElementById('fileInput');
        const cb = document.getElementById('channelComboBox');

        input.addEventListener('change', function (event) {
            const file = event.target.files[0];
            loadCSVFile(file, function (data) {
                channels = data;
                fillComboBox();
            })
        })

        cb.addEventListener('change', function (event) {
            render(event.target.value)
        })

        loadData();
        getFiles();

        // functions

        function loadData() {
            const path = './data/events/imola_2023/T2303_IMO_%2329/D1PMRun1/Tr491_Abs00006148_CAR 29_Lap0_cableData.csv';
            fetch(path).then(r => r.text())
                .then(csv => parseCSV(csv))
                .then(data => {
                    channels = data;
                    fillComboBox();
                })
                .catch(err => console.log(err));
        }

        function render(channel) {
            Plotly.newPlot("plotElement", /* JSON object */ {
                "data": [{ "y": channels[channel] }],
                "layout": { "width": 600, "height": 400 }
            })
        }

        function fillComboBox() {
            cb.innerHTML = '';
            Object.keys(channels).forEach(function (key) {
                const opt = document.createElement('option');
                opt.text = key;
                opt.value = key;
                cb.appendChild(opt);
            });
        }

        function parseCSV(csvData) {
            const lines = csvData.split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let j = 0; j < headers.length - 1; j++) {
                data[headers[j]] = [];
            }

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                for (let j = 0; j < values.length - 1; j++) {
                    if (j == 0) {
                        data[headers[j]][i - 1] = values[j];
                        continue;
                    }
                    data[headers[j]][i - 1] = parseFloat(values[j]);
                }
            }
            return data;
        }


        function loadCSVFile(file, callback) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const csvData = event.target.result;
                const parsedData = parseCSV(csvData);
                callback(parsedData);
            };
            reader.readAsText(file);
        }

        fetchCsvPaths(subfolderPath)
            .then(csvPaths => {
                const jsonResult = JSON.stringify(csvPaths);
                console.log('CSV file paths:', jsonResult);
                // Process the JSON result as needed
            })
            .catch(error => {
                console.error('Error fetching repository contents:', error);
            });

        function getFiles() {
            fetchCsvPaths(subfolderPath, branchName)
                .then(csvPaths => {
                    const jsonResult = JSON.stringify(csvPaths);
                    console.log('CSV file paths:', jsonResult);
                    // Process the JSON result as needed
                })
                .catch(error => {
                    console.error('Error fetching repository contents:', error);
                });
        }

        function fetchCsvPaths(folderPath) {
            const url = branchName == '' ? `${baseUrl}${folderPath}` : `${baseUrl}${folderPath}?ref=${branchName}`;
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    const csvFiles = data.filter(file => file.type === 'file' && file.name.endsWith('.csv'));
                    const csvPaths = csvFiles.map(file => file.path);

                    const subfolders = data.filter(file => file.type === 'dir');
                    const subfolderPromises = subfolders.map(subfolder => fetchCsvPaths(`${folderPath}/${subfolder.name}`, branchName));

                    return Promise.all(subfolderPromises)
                        .then(results => {
                            results.forEach(subfolderCsvPaths => {
                                csvPaths.push(...subfolderCsvPaths);
                            });
                            return csvPaths;
                        });
                });
        }

    </script>
</body>

</html>